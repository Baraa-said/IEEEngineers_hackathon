<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€â”€â”€ Variables â”€â”€â”€â”€â”€ */
:root{
  --bg:#0f172a;--card:#1e293b;--border:#334155;--card-hover:#253349;
  --txt:#e2e8f0;--muted:#94a3b8;--input-bg:#0f172a;
  --green:#22c55e;--red:#ef4444;--amber:#f59e0b;--blue:#3b82f6;
  --purple:#a855f7;--cyan:#06b6d4;--pink:#ec4899;
  --palestine-green:#009736;--palestine-red:#ce1126;
  --shadow:0 4px 24px rgba(0,0,0,.3);
  --font:'Cairo',sans-serif;
}
[data-theme="light"]{
  --bg:#f1f5f9;--card:#ffffff;--border:#e2e8f0;--card-hover:#f8fafc;
  --txt:#1e293b;--muted:#64748b;--input-bg:#f8fafc;
  --shadow:0 4px 24px rgba(0,0,0,.08);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--txt);min-height:100vh;transition:all .3s}

/* â”€â”€â”€â”€â”€ Header â”€â”€â”€â”€â”€ */
.header{background:linear-gradient(135deg,#000 0%,#1a1a2e 50%,var(--palestine-green) 100%);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:3px solid var(--palestine-red);flex-wrap:wrap;gap:10px}
.header h1{font-size:22px;font-weight:900;color:#fff}
.header .sub{color:#94a3b8;font-size:12px}
.header-controls{display:flex;align-items:center;gap:8px}
.header-btn{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff;padding:7px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600;transition:all .2s;display:flex;align-items:center;gap:5px}
.header-btn:hover{background:rgba(255,255,255,.25)}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;margin-inline-end:5px}

/* â”€â”€â”€â”€â”€ Tabs â”€â”€â”€â”€â”€ */
.tabs{display:flex;gap:0;background:var(--card);border-bottom:1px solid var(--border);overflow-x:auto}
.tab{padding:12px 24px;cursor:pointer;font-weight:600;font-size:13px;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;color:var(--muted)}
.tab:hover{color:var(--txt);background:var(--card-hover)}
.tab.active{color:var(--blue);border-bottom-color:var(--blue)}
.tab-content{display:none}.tab-content.active{display:block}

/* â”€â”€â”€â”€â”€ Container â”€â”€â”€â”€â”€ */
.container{max-width:1440px;margin:0 auto;padding:20px}

/* â”€â”€â”€â”€â”€ KPI â”€â”€â”€â”€â”€ */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:18px}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;position:relative;overflow:hidden;box-shadow:var(--shadow);transition:all .2s}
.kpi:hover{transform:translateY(-2px);border-color:var(--blue)}
.kpi .label{font-size:12px;color:var(--muted);margin-bottom:2px}
.kpi .value{font-size:28px;font-weight:900}
.kpi .sub-val{font-size:11px;color:var(--muted)}
.kpi::before{content:'';position:absolute;top:0;right:0;left:0;height:3px}
.kpi.green::before{background:var(--green)}.kpi.red::before{background:var(--red)}
.kpi.amber::before{background:var(--amber)}.kpi.blue::before{background:var(--blue)}
.kpi.purple::before{background:var(--purple)}.kpi.cyan::before{background:var(--cyan)}

/* â”€â”€â”€â”€â”€ Charts â”€â”€â”€â”€â”€ */
.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:14px;margin-bottom:18px}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;box-shadow:var(--shadow)}
.chart-card h3{font-size:14px;margin-bottom:10px;display:flex;align-items:center;gap:6px}

/* â”€â”€â”€â”€â”€ Tables & Forms â”€â”€â”€â”€â”€ */
.data-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:var(--shadow)}
.data-card h3{font-size:15px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}
table{width:100%;border-collapse:collapse}
th,td{padding:9px 12px;text-align:inherit;border-bottom:1px solid var(--border);font-size:12px}
th{color:var(--muted);font-weight:600;text-transform:uppercase;font-size:11px}
.badge{padding:2px 10px;border-radius:20px;font-size:10px;font-weight:600;display:inline-block}
.badge-green{background:rgba(34,197,94,.15);color:var(--green)}
.badge-red{background:rgba(239,68,68,.15);color:var(--red)}
.badge-amber{background:rgba(245,158,11,.15);color:var(--amber)}
.badge-blue{background:rgba(59,130,246,.15);color:var(--blue)}

/* â”€â”€â”€â”€â”€ Buttons â”€â”€â”€â”€â”€ */
.btn{padding:7px 16px;border:none;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600;transition:all .2s}
.btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{opacity:.85}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{opacity:.85}
.btn-sm{padding:4px 10px;font-size:11px;border-radius:6px}
.btn-success{background:var(--green);color:#fff}

/* â”€â”€â”€â”€â”€ Modal â”€â”€â”€â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;justify-content:center;align-items:center}
.modal-overlay.active{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;width:90%;max-width:520px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.4)}
.modal h3{margin-bottom:16px;font-size:17px}
.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px;font-weight:600}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:9px 12px;background:var(--input-bg);border:1px solid var(--border);border-radius:8px;color:var(--txt);font-family:var(--font);font-size:13px}
.form-group textarea{min-height:60px;resize:vertical}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

/* â”€â”€â”€â”€â”€ Loading â”€â”€â”€â”€â”€ */
.loading{display:flex;justify-content:center;align-items:center;height:300px;font-size:16px;color:var(--muted)}
.spinner{border:4px solid var(--border);border-top:4px solid var(--green);border-radius:50%;width:36px;height:36px;animation:spin .8s linear infinite;margin-inline-end:10px}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€â”€â”€â”€ Toast â”€â”€â”€â”€â”€ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:10px;font-size:13px;font-weight:600;z-index:2000;opacity:0;transition:opacity .3s}
.toast.show{opacity:1}.toast-success{background:var(--green);color:#fff}.toast-error{background:var(--red);color:#fff}

/* â”€â”€â”€â”€â”€ Map â”€â”€â”€â”€â”€ */
#facilityMap{width:100%;height:550px;border-radius:12px;border:1px solid var(--border);z-index:1}
.map-legend{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px}
.map-legend-item{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--txt)}
.map-legend-dot{width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,.3)}
.map-filters{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.map-chip{padding:5px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--muted);transition:all .2s;font-family:var(--font)}
.map-chip:hover{border-color:var(--blue);color:var(--txt)}
.map-chip.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.map-popup h4{margin:0 0 4px;font-size:14px;color:#1e293b}
.map-popup .mp-row{font-size:12px;color:#475569;margin:2px 0}
.map-popup .mp-badge{display:inline-block;padding:1px 8px;border-radius:10px;font-size:10px;font-weight:600}

@media(max-width:768px){
  .charts-grid{grid-template-columns:1fr}
  .kpi-row{grid-template-columns:repeat(2,1fr)}
  .header{text-align:center}
  .form-row{grid-template-columns:1fr}
  #facilityMap{height:400px}
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div>
    <h1 id="headerTitle">ğŸ¥ ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
    <div class="sub"><span class="status-dot"></span><span id="headerSub">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø²Ù…Ø§Øª â€” Ø§Ù„Ø¶ÙØ© Ø§Ù„ØºØ±Ø¨ÙŠØ©ØŒ ÙÙ„Ø³Ø·ÙŠÙ†</span></div>
  </div>
  <div class="header-controls">
    <button class="header-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™ <span id="themeLbl">ÙØ§ØªØ­</span></button>
    <button class="header-btn" onclick="toggleLang()" id="langBtn">ğŸŒ English</button>
  </div>
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')"><span class="tab-text" data-i18n="tab_dashboard">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span></div>
  <div class="tab" data-tab="facilities" onclick="switchTab('facilities')"><span class="tab-text" data-i18n="tab_facilities">ğŸ¥ Ø§Ù„Ù…Ø±Ø§ÙÙ‚</span></div>
  <div class="tab" data-tab="resources" onclick="switchTab('resources')"><span class="tab-text" data-i18n="tab_resources">ğŸš‘ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯</span></div>
  <div class="tab" data-tab="incidents" onclick="switchTab('incidents')"><span class="tab-text" data-i18n="tab_incidents">âš ï¸ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</span></div>
  <div class="tab" data-tab="map" onclick="switchTab('map');initMap()"><span class="tab-text" data-i18n="tab_map">ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</span></div>
</div>

<!-- Dashboard Tab -->
<div class="tab-content active" id="tab-dashboard">
  <div class="container">
    <!-- SOS ALERTS BANNER -->
    <div id="sosAlertsBanner" style="display:none;margin-bottom:16px">
      <div style="background:linear-gradient(135deg,#dc2626,#991b1b);border-radius:14px;padding:18px 22px;box-shadow:0 4px 20px rgba(220,38,38,.35);border:2px solid #fca5a5;animation:sosPulse 2s infinite">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:28px;animation:sosShake .5s infinite">ğŸš¨</span>
            <div>
              <div style="color:#fff;font-weight:900;font-size:17px" id="sosAlertTitle">SOS ALERTS</div>
              <div style="color:#fecaca;font-size:12px" id="sosAlertSub">Real-time emergency reports from mobile users</div>
            </div>
          </div>
          <span style="background:rgba(255,255,255,.2);color:#fff;padding:4px 14px;border-radius:20px;font-size:13px;font-weight:700" id="sosAlertCount">0</span>
        </div>
        <div id="sosAlertList" style="margin-top:14px;display:flex;flex-direction:column;gap:8px"></div>
      </div>
    </div>
    <style>
      @keyframes sosPulse{0%,100%{box-shadow:0 4px 20px rgba(220,38,38,.35)}50%{box-shadow:0 4px 30px rgba(220,38,38,.6)}}
      @keyframes sosShake{0%,100%{transform:rotate(0)}25%{transform:rotate(-8deg)}75%{transform:rotate(8deg)}}
      .sos-card{background:rgba(255,255,255,.12);border-radius:10px;padding:12px 16px;color:#fff;display:flex;align-items:flex-start;gap:12px}
      .sos-card .sos-icon{font-size:22px;margin-top:2px}
      .sos-card .sos-info{flex:1}
      .sos-card .sos-info h4{margin:0;font-size:14px;font-weight:700}
      .sos-card .sos-info p{margin:3px 0 0;font-size:11px;color:#fecaca}
      .sos-card .sos-time{font-size:10px;color:#fca5a5;white-space:nowrap}
      .sos-card .sos-locate{background:rgba(255,255,255,.2);border:none;color:#fff;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600}
      .sos-card .sos-locate:hover{background:rgba(255,255,255,.35)}
    </style>
    <!-- END SOS ALERTS BANNER -->

    <div id="loading" class="loading"><div class="spinner"></div><span data-i18n="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span></div>
    <div id="dashContent" style="display:none">
      <div class="kpi-row" id="kpi-row"></div>
      <div class="charts-grid">
        <div class="chart-card"><h3>ğŸ¥ <span data-i18n="fac_by_status">Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</span></h3><canvas id="chartFacStatus"></canvas></div>
        <div class="chart-card"><h3>ğŸ“Š <span data-i18n="fac_by_type">Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</span></h3><canvas id="chartFacType"></canvas></div>
        <div class="chart-card"><h3>ğŸ›ï¸ <span data-i18n="beds_chart">Ø§Ù„Ø£Ø³Ø±Ù‘Ø©: Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©</span></h3><canvas id="chartBeds"></canvas></div>
        <div class="chart-card"><h3>ğŸš‘ <span data-i18n="res_by_type">Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</span></h3><canvas id="chartResType"></canvas></div>
        <div class="chart-card"><h3>âš ï¸ <span data-i18n="inc_by_sev">Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·ÙˆØ±Ø©</span></h3><canvas id="chartIncSev"></canvas></div>
        <div class="chart-card"><h3>ğŸ“ <span data-i18n="inc_by_dist">Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</span></h3><canvas id="chartIncDistrict"></canvas></div>
        <div class="chart-card"><h3>ğŸ›ï¸ <span data-i18n="fac_by_gov">Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</span></h3><canvas id="chartFacGov"></canvas></div>
        <div class="chart-card"><h3>ğŸ“¦ <span data-i18n="res_by_status">Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</span></h3><canvas id="chartResStatus"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- Facilities Tab -->
<div class="tab-content" id="tab-facilities">
  <div class="container">
    <div class="data-card">
      <h3><span>ğŸ¥ <span data-i18n="manage_fac">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚</span></span><button class="btn btn-primary" onclick="openModal('facility')">+ <span data-i18n="add_new">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</span></button></h3>
      <table><thead><tr>
        <th data-i18n="name">Ø§Ù„Ø§Ø³Ù…</th><th data-i18n="type">Ø§Ù„Ù†ÙˆØ¹</th><th data-i18n="status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th data-i18n="governorate">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th><th data-i18n="beds">Ø£Ø³Ø±Ù‘Ø©</th><th data-i18n="power">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</th><th data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr></thead><tbody id="facTable"></tbody></table>
    </div>
  </div>
</div>

<!-- Resources Tab -->
<div class="tab-content" id="tab-resources">
  <div class="container">
    <div class="data-card">
      <h3><span>ğŸš‘ <span data-i18n="manage_res">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯</span></span><button class="btn btn-primary" onclick="openModal('resource')">+ <span data-i18n="add_new">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</span></button></h3>
      <table><thead><tr>
        <th data-i18n="name">Ø§Ù„Ø§Ø³Ù…</th><th data-i18n="type">Ø§Ù„Ù†ÙˆØ¹</th><th data-i18n="status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th data-i18n="district">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th data-i18n="capacity">Ø§Ù„Ø³Ø¹Ø©</th><th data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr></thead><tbody id="resTable"></tbody></table>
    </div>
  </div>
</div>

<!-- Incidents Tab -->
<div class="tab-content" id="tab-incidents">
  <div class="container">
    <div class="data-card">
      <h3><span>âš ï¸ <span data-i18n="manage_inc">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</span></span><button class="btn btn-primary" onclick="openModal('incident')">+ <span data-i18n="add_new">Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯</span></button></h3>
      <table><thead><tr>
        <th data-i18n="title">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th data-i18n="type">Ø§Ù„Ù†ÙˆØ¹</th><th data-i18n="severity">Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
        <th data-i18n="district">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th><th data-i18n="active">Ù†Ø´Ø·</th><th data-i18n="actions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr></thead><tbody id="incTable"></tbody></table>
    </div>
  </div>
</div>

<!-- Map Tab -->
<div class="tab-content" id="tab-map">
  <div class="container">
    <div class="data-card">
      <h3><span>ğŸ—ºï¸ <span data-i18n="crisis_map">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø²Ù…Ø§Øª</span></span></h3>
      <div class="map-legend" id="mapLegend"></div>
      <div class="map-filters" id="mapFilters"></div>
      <div id="facilityMap"></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalContent"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â• CONFIG â•â•â•â•â•â•â• */
const API = window.location.origin;
const H = {'Content-Type':'application/json','ngrok-skip-browser-warning':'true'};
let LANG = localStorage.getItem('lang')||'ar';
let THEME = localStorage.getItem('theme')||'dark';
let chartInstances = {};

/* â•â•â•â•â•â•â• i18n â•â•â•â•â•â•â• */
const I18N = {
  ar:{
    tab_dashboard:'ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',tab_facilities:'ğŸ¥ Ø§Ù„Ù…Ø±Ø§ÙÙ‚',tab_resources:'ğŸš‘ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯',tab_incidents:'âš ï¸ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«',
    loading:'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...',fac_by_status:'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©',fac_by_type:'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹',
    beds_chart:'Ø§Ù„Ø£Ø³Ø±Ù‘Ø©: Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…Ø´ØºÙˆÙ„Ø©',res_by_type:'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹',inc_by_sev:'Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·ÙˆØ±Ø©',
    inc_by_dist:'Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©',fac_by_gov:'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©',res_by_status:'Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©',
    manage_fac:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚',manage_res:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯',manage_inc:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø«',
    add_new:'Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯',name:'Ø§Ù„Ø§Ø³Ù…',type:'Ø§Ù„Ù†ÙˆØ¹',status:'Ø§Ù„Ø­Ø§Ù„Ø©',governorate:'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©',
    beds:'Ø£Ø³Ø±Ù‘Ø©',power:'ÙƒÙ‡Ø±Ø¨Ø§Ø¡',actions:'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª',district:'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',capacity:'Ø§Ù„Ø³Ø¹Ø©',
    title:'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',severity:'Ø§Ù„Ø®Ø·ÙˆØ±Ø©',active:'Ù†Ø´Ø·',
    total_fac:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø§ÙÙ‚',avail_beds:'Ø§Ù„Ø£Ø³Ø±Ù‘Ø© Ø§Ù„Ù…ØªÙˆÙØ±Ø©',icu_beds:'Ø¹Ù†Ø§ÙŠØ© Ù…Ø±ÙƒØ²Ø©',
    total_res:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯',active_inc:'Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù†Ø´Ø·Ø©',shelter_cap:'Ø³Ø¹Ø© Ø§Ù„Ù…Ù„Ø§Ø¬Ø¦',
    with_power:'ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ù…ØªÙˆÙØ±Ø©',with_oxygen:'Ø£ÙƒØ³Ø¬ÙŠÙ† Ù…ØªÙˆÙØ±',
    operational:'Ø¹Ø§Ù…Ù„',of:'Ù…Ù†',available:'Ù…ØªÙˆÙØ±',occupancy:'Ø¥Ø´ØºØ§Ù„',facility:'Ù…Ø±ÙÙ‚',
    edit:'ØªØ¹Ø¯ÙŠÙ„',delete:'Ø­Ø°Ù',save:'Ø­ÙØ¸',cancel:'Ø¥Ù„ØºØ§Ø¡',confirm_delete:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ',
    add_facility:'Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚',edit_facility:'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±ÙÙ‚',add_resource:'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯',edit_resource:'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ±Ø¯',
    add_incident:'Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ø¯Ø«',edit_incident:'ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ø¯Ø«',
    name_ar:'Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',latitude:'Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶',longitude:'Ø®Ø· Ø§Ù„Ø·ÙˆÙ„',address:'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
    total_beds:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø±Ù‘Ø©',available_beds:'Ø§Ù„Ø£Ø³Ø±Ù‘Ø© Ø§Ù„Ù…ØªÙˆÙØ±Ø©',icu_total:'Ø¹Ù†Ø§ÙŠØ© Ø¥Ø¬Ù…Ø§Ù„ÙŠ',icu_avail:'Ø¹Ù†Ø§ÙŠØ© Ù…ØªÙˆÙØ±',
    has_power:'ÙƒÙ‡Ø±Ø¨Ø§Ø¡',has_oxygen:'Ø£ÙƒØ³Ø¬ÙŠÙ†',phone:'Ø§Ù„Ù‡Ø§ØªÙ',description:'Ø§Ù„ÙˆØµÙ',
    contact_name:'Ø§Ø³Ù… Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„',contact_phone:'Ù‡Ø§ØªÙ Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„',total_capacity:'Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©',
    current_occ:'Ø§Ù„Ø¥Ø´ØºØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ',reported_by:'Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¨ÙˆØ§Ø³Ø·Ø©',is_active:'Ù†Ø´Ø·',
    header_title:'ğŸ¥ ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª â€” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',header_sub:'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø²Ù…Ø§Øª â€” Ø§Ù„Ø¶ÙØ© Ø§Ù„ØºØ±Ø¨ÙŠØ©ØŒ ÙÙ„Ø³Ø·ÙŠÙ†',
    theme_light:'ÙØ§ØªØ­',theme_dark:'Ø¯Ø§ÙƒÙ†',
    created:'ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­',updated:'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­',deleted:'ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­',error_op:'Ø­Ø¯Ø« Ø®Ø·Ø£',
    total:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ',avail:'Ù…ØªÙˆÙØ±',general_beds:'Ø£Ø³Ø±Ù‘Ø© Ø¹Ø§Ù…Ø©',icu_label:'Ø¹Ù†Ø§ÙŠØ© Ù…Ø±ÙƒØ²Ø©',
    tab_map:'ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø©',crisis_map:'Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø²Ù…Ø§Øª â€” Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø§Ù„ØµØ­ÙŠØ©',
  },
  en:{
    tab_dashboard:'ğŸ“Š Dashboard',tab_facilities:'ğŸ¥ Facilities',tab_resources:'ğŸš‘ Resources',tab_incidents:'âš ï¸ Incidents',
    loading:'Loading data...',fac_by_status:'Facilities by Status',fac_by_type:'Facilities by Type',
    beds_chart:'Beds: Available vs Total',res_by_type:'Resources by Type',inc_by_sev:'Incidents by Severity',
    inc_by_dist:'Incidents by District',fac_by_gov:'Facilities by Governorate',res_by_status:'Resources by Status',
    manage_fac:'Manage Facilities',manage_res:'Manage Resources',manage_inc:'Manage Incidents',
    add_new:'Add New',name:'Name',type:'Type',status:'Status',governorate:'Governorate',
    beds:'Beds',power:'Power',actions:'Actions',district:'District',capacity:'Capacity',
    title:'Title',severity:'Severity',active:'Active',
    total_fac:'Total Facilities',avail_beds:'Available Beds',icu_beds:'ICU Beds',
    total_res:'Total Resources',active_inc:'Active Incidents',shelter_cap:'Shelter Capacity',
    with_power:'With Power',with_oxygen:'With Oxygen',
    operational:'operational',of:'of',available:'available',occupancy:'occupancy',facility:'facility',
    edit:'Edit',delete:'Delete',save:'Save',cancel:'Cancel',confirm_delete:'Confirm delete?',
    add_facility:'Add Facility',edit_facility:'Edit Facility',add_resource:'Add Resource',edit_resource:'Edit Resource',
    add_incident:'Add Incident',edit_incident:'Edit Incident',
    name_ar:'Name (Arabic)',latitude:'Latitude',longitude:'Longitude',address:'Address',
    total_beds:'Total Beds',available_beds:'Available Beds',icu_total:'ICU Total',icu_avail:'ICU Available',
    has_power:'Power',has_oxygen:'Oxygen',phone:'Phone',description:'Description',
    contact_name:'Contact Name',contact_phone:'Contact Phone',total_capacity:'Total Capacity',
    current_occ:'Current Occupancy',reported_by:'Reported By',is_active:'Active',
    header_title:'ğŸ¥ Situation Room â€” Admin Dashboard',header_sub:'Crisis Management â€” West Bank, Palestine',
    theme_light:'Light',theme_dark:'Dark',
    created:'Created successfully',updated:'Updated successfully',deleted:'Deleted successfully',error_op:'An error occurred',
    total:'Total',avail:'Available',general_beds:'General Beds',icu_label:'ICU',
    tab_map:'ğŸ—ºï¸ Map',crisis_map:'Crisis Map â€” Health Facilities',
  }
};
const t = k => I18N[LANG]?.[k] || I18N['en']?.[k] || k;

const STATUS_LABELS={ar:{operational:'Ø¹Ø§Ù…Ù„',reduced_capacity:'Ø·Ø§Ù‚Ø© Ù…Ø®ÙØ¶Ø©',damaged:'Ù…ØªØ¶Ø±Ø±',offline:'ØºÙŠØ± Ù…ØªØµÙ„'},en:{operational:'Operational',reduced_capacity:'Reduced',damaged:'Damaged',offline:'Offline'}};
const TYPE_LABELS={ar:{hospital:'Ù…Ø³ØªØ´ÙÙ‰',clinic:'Ø¹ÙŠØ§Ø¯Ø©',pharmacy:'ØµÙŠØ¯Ù„ÙŠØ©',field_hospital:'Ù…Ø³ØªØ´ÙÙ‰ Ù…ÙŠØ¯Ø§Ù†ÙŠ',health_center:'Ù…Ø±ÙƒØ² ØµØ­ÙŠ'},en:{hospital:'Hospital',clinic:'Clinic',pharmacy:'Pharmacy',field_hospital:'Field Hospital',health_center:'Health Center'}};
const RES_LABELS={ar:{ambulance:'Ø¥Ø³Ø¹Ø§Ù',shelter:'Ù…Ø£ÙˆÙ‰',medical_supply:'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨ÙŠØ©',distribution_point:'Ù†Ù‚Ø·Ø© ØªÙˆØ²ÙŠØ¹',water_point:'Ù†Ù‚Ø·Ø© Ù…ÙŠØ§Ù‡'},en:{ambulance:'Ambulance',shelter:'Shelter',medical_supply:'Medical Supply',distribution_point:'Distribution',water_point:'Water Point'}};
const SEV_LABELS={ar:{critical:'Ø­Ø±Ø¬',high:'Ø¹Ø§Ù„ÙŠ',medium:'Ù…ØªÙˆØ³Ø·',low:'Ù…Ù†Ø®ÙØ¶'},en:{critical:'Critical',high:'High',medium:'Medium',low:'Low'}};
const RES_STATUS_LABELS={ar:{available:'Ù…ØªÙˆÙØ±',in_use:'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…',depleted:'Ù†ÙØ°',maintenance:'ØµÙŠØ§Ù†Ø©'},en:{available:'Available',in_use:'In Use',depleted:'Depleted',maintenance:'Maintenance'}};

const sLabel = s => STATUS_LABELS[LANG]?.[s]||s;
const tLabel = s => TYPE_LABELS[LANG]?.[s]||s;
const rLabel = s => RES_LABELS[LANG]?.[s]||s;
const sevLabel = s => SEV_LABELS[LANG]?.[s]||s;
const rsLabel = s => RES_STATUS_LABELS[LANG]?.[s]||s;

const PALETTE = ['#3b82f6','#22c55e','#f59e0b','#ef4444','#a855f7','#06b6d4','#ec4899','#10b981','#f97316','#6366f1','#14b8a6'];

/* â•â•â•â•â•â•â• Helpers â•â•â•â•â•â•â• */
async function api(path,method='GET',body=null){
  const opts={method,headers:H};
  if(body) opts.body=JSON.stringify(body);
  const r=await fetch(API+path,opts);
  if(!r.ok) throw new Error(`${r.status}`);
  return r.json();
}

function toast(msg,type='success'){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className=`toast toast-${type} show`;
  setTimeout(()=>el.classList.remove('show'),3000);
}

function sevBadge(s){const c=s==='critical'||s==='high'?'badge-red':s==='medium'?'badge-amber':'badge-green';return `<span class="badge ${c}">${sevLabel(s)}</span>`;}
function statusBadge(s){const c=s==='operational'?'badge-green':s==='damaged'||s==='offline'?'badge-red':'badge-amber';return `<span class="badge ${c}">${sLabel(s)}</span>`;}
function makeKPI(label,value,sub,cls){return `<div class="kpi ${cls}"><div class="label">${label}</div><div class="value">${value}</div>${sub?`<div class="sub-val">${sub}</div>`:''}</div>`;}

/* â•â•â•â•â•â•â• Theme & Lang â•â•â•â•â•â•â• */
function applyTheme(){
  document.documentElement.setAttribute('data-theme',THEME);
  document.getElementById('themeLbl').textContent=THEME==='dark'?t('theme_light'):t('theme_dark');
  document.getElementById('themeBtn').querySelector('span').previousSibling.textContent=THEME==='dark'?'â˜€ï¸ ':'ğŸŒ™ ';
}
function toggleTheme(){THEME=THEME==='dark'?'light':'dark';localStorage.setItem('theme',THEME);applyTheme();}

function applyLang(){
  const dir=LANG==='ar'?'rtl':'ltr';
  document.documentElement.setAttribute('dir',dir);
  document.documentElement.setAttribute('lang',LANG);
  document.body.style.fontFamily=LANG==='ar'?"'Cairo',sans-serif":"'Inter',sans-serif";
  document.getElementById('langBtn').textContent=LANG==='ar'?'ğŸŒ English':'ğŸŒ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
  document.getElementById('headerTitle').textContent=t('header_title');
  document.getElementById('headerSub').textContent=t('header_sub');
  document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');el.textContent=t(k);});
}
function toggleLang(){LANG=LANG==='ar'?'en':'ar';localStorage.setItem('lang',LANG);applyLang();loadAll();}

/* â•â•â•â•â•â•â• Tabs â•â•â•â•â•â•â• */
function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.toggle('active',c.id==='tab-'+name));
}

/* â•â•â•â•â•â•â• Charts â•â•â•â•â•â•â• */
function destroyCharts(){Object.values(chartInstances).forEach(c=>c.destroy());chartInstances={};}

function doughnut(id,labels,data,colors){
  chartInstances[id]=new Chart(document.getElementById(id),{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors||PALETTE.slice(0,labels.length),borderWidth:0}]},options:{responsive:true,plugins:{legend:{position:'bottom',labels:{padding:10,font:{family:LANG==='ar'?'Cairo':'Inter',size:11}}}}}});
}
function hbar(id,labels,data,colors){
  chartInstances[id]=new Chart(document.getElementById(id),{type:'bar',data:{labels,datasets:[{data,backgroundColor:colors||PALETTE.slice(0,labels.length),borderRadius:5,borderSkipped:false}]},options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{display:false}}}}});
}
function bar(id,labels,datasets){
  chartInstances[id]=new Chart(document.getElementById(id),{type:'bar',data:{labels,datasets},options:{responsive:true,plugins:{legend:{position:'top',labels:{font:{family:LANG==='ar'?'Cairo':'Inter'}}}},scales:{x:{grid:{display:false}},y:{grid:{color:THEME==='dark'?'#1e293b':'#e2e8f0'}}}}});
}

/* â•â•â•â•â•â•â• Dashboard â•â•â•â•â•â•â• */
async function loadDashboard(){
  try{
    const d=await api('/api/v1/dashboard/stats');
    const bedPct=d.facilities.total_beds?Math.round(d.facilities.available_beds/d.facilities.total_beds*100):0;
    const shPct=d.resources.shelter_capacity?Math.round(d.resources.shelter_occupancy/d.resources.shelter_capacity*100):0;
    document.getElementById('kpi-row').innerHTML=[
      makeKPI(t('total_fac'),d.facilities.total,`${d.facilities.by_status?.operational||0} ${t('operational')}`,'green'),
      makeKPI(t('avail_beds'),`${d.facilities.available_beds}/${d.facilities.total_beds}`,`${bedPct}% ${t('occupancy')}`,'blue'),
      makeKPI(t('icu_beds'),`${d.facilities.available_icu}/${d.facilities.total_icu}`,``,'purple'),
      makeKPI(t('total_res'),d.resources.total,`${d.resources.by_status?.available||0} ${t('available')}`,'cyan'),
      makeKPI(t('active_inc'),d.incidents.active,`${t('of')} ${d.incidents.total} ${t('total')}`,'red'),
      makeKPI(t('shelter_cap'),d.resources.shelter_capacity,`${shPct}% ${t('occupancy')}`,'amber'),
      makeKPI(t('with_power'),d.facilities.with_power,`${t('of')} ${d.facilities.total} ${t('facility')}`,'green'),
      makeKPI(t('with_oxygen'),d.facilities.with_oxygen,`${t('of')} ${d.facilities.total} ${t('facility')}`,'blue'),
    ].join('');

    destroyCharts();
    const fs=d.facilities.by_status;
    doughnut('chartFacStatus',Object.keys(fs).map(sLabel),Object.values(fs),['#22c55e','#f59e0b','#ef4444','#a855f7']);
    const ft=d.facilities.by_type;
    doughnut('chartFacType',Object.keys(ft).map(tLabel),Object.values(ft));
    bar('chartBeds',[t('general_beds'),t('icu_label')],[{label:t('total'),data:[d.facilities.total_beds,d.facilities.total_icu],backgroundColor:'#3b82f6',borderRadius:5},{label:t('avail'),data:[d.facilities.available_beds,d.facilities.available_icu],backgroundColor:'#22c55e',borderRadius:5}]);
    doughnut('chartResType',Object.keys(d.resources.by_type).map(rLabel),Object.values(d.resources.by_type));
    doughnut('chartResStatus',Object.keys(d.resources.by_status).map(rsLabel),Object.values(d.resources.by_status),['#22c55e','#3b82f6','#ef4444','#f59e0b']);
    const iSev=d.incidents.by_severity;
    doughnut('chartIncSev',Object.keys(iSev).map(sevLabel),Object.values(iSev),['#ef4444','#f97316','#f59e0b','#22c55e']);
    hbar('chartIncDistrict',Object.keys(d.incidents.by_district),Object.values(d.incidents.by_district));
    hbar('chartFacGov',Object.keys(d.facilities.by_governorate),Object.values(d.facilities.by_governorate));

    document.getElementById('loading').style.display='none';
    document.getElementById('dashContent').style.display='block';
  }catch(e){document.getElementById('loading').innerHTML=`<span style="color:var(--red)">âŒ ${e.message}</span>`;}
}

/* â•â•â•â•â•â•â• CRUD Tables â•â•â•â•â•â•â• */
let allFacilities=[],allResources=[],allIncidents=[];

async function loadFacilities(){
  allFacilities=await api('/api/v1/facilities?limit=200');
  const tb=document.getElementById('facTable');
  tb.innerHTML=allFacilities.map(f=>`<tr>
    <td>${f.name}</td><td>${tLabel(f.facility_type)}</td><td>${statusBadge(f.status)}</td>
    <td>${f.governorate||'-'}</td><td>${f.available_beds}/${f.total_beds}</td>
    <td>${f.has_power?'âœ…':'âŒ'}</td>
    <td><button class="btn btn-sm btn-primary" onclick="editFacility('${f.id}')">${t('edit')}</button> <button class="btn btn-sm btn-danger" onclick="deleteItem('facilities','${f.id}')">${t('delete')}</button></td>
  </tr>`).join('');
}

async function loadResources(){
  allResources=await api('/api/v1/resources?limit=200');
  const tb=document.getElementById('resTable');
  tb.innerHTML=allResources.map(r=>`<tr>
    <td>${r.name}</td><td>${rLabel(r.resource_type)}</td><td><span class="badge badge-blue">${rsLabel(r.status)}</span></td>
    <td>${r.district||'-'}</td><td>${r.total_capacity||0}</td>
    <td><button class="btn btn-sm btn-primary" onclick="editResource('${r.id}')">${t('edit')}</button> <button class="btn btn-sm btn-danger" onclick="deleteItem('resources','${r.id}')">${t('delete')}</button></td>
  </tr>`).join('');
}

async function loadIncidents(){
  allIncidents=await api('/api/v1/incidents?limit=200');
  const tb=document.getElementById('incTable');
  tb.innerHTML=allIncidents.map(i=>`<tr>
    <td>${i.title}</td><td>${i.incident_type}</td><td>${sevBadge(i.severity)}</td>
    <td>${i.district||'-'}</td><td>${i.is_active?'âœ…':'âŒ'}</td>
    <td><button class="btn btn-sm btn-primary" onclick="editIncident('${i.id}')">${t('edit')}</button> <button class="btn btn-sm btn-danger" onclick="deleteItem('incidents','${i.id}')">${t('delete')}</button></td>
  </tr>`).join('');
}

async function deleteItem(entity,id){
  if(!confirm(t('confirm_delete')))return;
  try{await api(`/api/v1/${entity}/${id}`,'DELETE');toast(t('deleted'));loadAll();}
  catch(e){toast(t('error_op'),'error');}
}

/* â•â•â•â•â•â•â• Modals â•â•â•â•â•â•â• */
function closeModal(){document.getElementById('modalOverlay').classList.remove('active');}

function openModal(type,data=null){
  const isEdit=!!data;
  let html='';
  if(type==='facility'){
    const d=data||{};
    html=`<h3>${isEdit?t('edit_facility'):t('add_facility')}</h3>
    <div class="form-row"><div class="form-group"><label>${t('name')}</label><input id="f_name" value="${d.name||''}"></div><div class="form-group"><label>${t('name_ar')}</label><input id="f_name_ar" value="${d.name_ar||''}"></div></div>
    <div class="form-row"><div class="form-group"><label>${t('type')}</label><select id="f_type"><option value="hospital" ${d.facility_type==='hospital'?'selected':''}>Hospital</option><option value="clinic" ${d.facility_type==='clinic'?'selected':''}>Clinic</option><option value="pharmacy" ${d.facility_type==='pharmacy'?'selected':''}>Pharmacy</option><option value="health_center" ${d.facility_type==='health_center'?'selected':''}>Health Center</option></select></div>
    <div class="form-group"><label>${t('status')}</label><select id="f_status"><option value="operational" ${d.status==='operational'?'selected':''}>Operational</option><option value="reduced_capacity" ${d.status==='reduced_capacity'?'selected':''}>Reduced</option><option value="damaged" ${d.status==='damaged'?'selected':''}>Damaged</option><option value="offline" ${d.status==='offline'?'selected':''}>Offline</option></select></div></div>
    <div class="form-row"><div class="form-group"><label>${t('latitude')}</label><input type="number" step="any" id="f_lat" value="${d.latitude||31.9}"></div><div class="form-group"><label>${t('longitude')}</label><input type="number" step="any" id="f_lon" value="${d.longitude||35.2}"></div></div>
    <div class="form-row"><div class="form-group"><label>${t('governorate')}</label><input id="f_gov" value="${d.governorate||''}"></div><div class="form-group"><label>${t('district')}</label><input id="f_dist" value="${d.district||''}"></div></div>
    <div class="form-group"><label>${t('address')}</label><input id="f_addr" value="${d.address||''}"></div>
    <div class="form-row"><div class="form-group"><label>${t('total_beds')}</label><input type="number" id="f_tbeds" value="${d.total_beds||0}"></div><div class="form-group"><label>${t('available_beds')}</label><input type="number" id="f_abeds" value="${d.available_beds||0}"></div></div>
    <div class="form-row"><div class="form-group"><label>${t('icu_total')}</label><input type="number" id="f_ticu" value="${d.icu_beds||0}"></div><div class="form-group"><label>${t('icu_avail')}</label><input type="number" id="f_aicu" value="${d.icu_available||0}"></div></div>
    <div class="form-row"><div class="form-group"><label>${t('has_power')}</label><select id="f_power"><option value="true" ${d.has_power!==false?'selected':''}>âœ…</option><option value="false" ${d.has_power===false?'selected':''}>âŒ</option></select></div>
    <div class="form-group"><label>${t('has_oxygen')}</label><select id="f_oxy"><option value="true" ${d.has_oxygen!==false?'selected':''}>âœ…</option><option value="false" ${d.has_oxygen===false?'selected':''}>âŒ</option></select></div></div>
    <div class="form-group"><label>${t('phone')}</label><input id="f_phone" value="${d.phone||''}"></div>
    <div class="modal-actions"><button class="btn btn-primary" onclick="saveFacility(${isEdit?`'${d.id}'`:'null'})">${t('save')}</button><button class="btn" style="background:var(--border)" onclick="closeModal()">${t('cancel')}</button></div>`;
  }else if(type==='resource'){
    const d=data||{};
    html=`<h3>${isEdit?t('edit_resource'):t('add_resource')}</h3>
    <div class="form-group"><label>${t('name')}</label><input id="r_name" value="${d.name||''}"></div>
    <div class="form-row"><div class="form-group"><label>${t('type')}</label><select id="r_type"><option value="ambulance" ${d.resource_type==='ambulance'?'selected':''}>Ambulance</option><option value="shelter" ${d.resource_type==='shelter'?'selected':''}>Shelter</option><option value="medical_supply" ${d.resource_type==='medical_supply'?'selected':''}>Medical Supply</option><option value="distribution_point" ${d.resource_type==='distribution_point'?'selected':''}>Distribution</option><option value="water_point" ${d.resource_type==='water_point'?'selected':''}>Water Point</option></select></div>
    <div class="form-group"><label>${t('status')}</label><select id="r_status"><option value="available" ${d.status==='available'?'selected':''}>Available</option><option value="in_use" ${d.status==='in_use'?'selected':''}>In Use</option><option value="depleted" ${d.status==='depleted'?'selected':''}>Depleted</option><option value="maintenance" ${d.status==='maintenance'?'selected':''}>Maintenance</option></select></div></div>
    <div class="form-row"><div class="form-group"><label>${t('latitude')}</label><input type="number" step="any" id="r_lat" value="${d.latitude||31.9}"></div><div class="form-group"><label>${t('longitude')}</label><input type="number" step="any" id="r_lon" value="${d.longitude||35.2}"></div></div>
    <div class="form-row"><div class="form-group"><label>${t('district')}</label><input id="r_dist" value="${d.district||''}"></div><div class="form-group"><label>${t('total_capacity')}</label><input type="number" id="r_cap" value="${d.total_capacity||0}"></div></div>
    <div class="form-group"><label>${t('description')}</label><textarea id="r_desc">${d.description||''}</textarea></div>
    <div class="form-row"><div class="form-group"><label>${t('contact_name')}</label><input id="r_cname" value="${d.contact_name||''}"></div><div class="form-group"><label>${t('contact_phone')}</label><input id="r_cphone" value="${d.contact_phone||''}"></div></div>
    <div class="modal-actions"><button class="btn btn-primary" onclick="saveResource(${isEdit?`'${d.id}'`:'null'})">${t('save')}</button><button class="btn" style="background:var(--border)" onclick="closeModal()">${t('cancel')}</button></div>`;
  }else if(type==='incident'){
    const d=data||{};
    html=`<h3>${isEdit?t('edit_incident'):t('add_incident')}</h3>
    <div class="form-group"><label>${t('title')}</label><input id="i_title" value="${d.title||''}"></div>
    <div class="form-row"><div class="form-group"><label>${t('type')}</label><select id="i_type"><option value="road_closure" ${d.incident_type==='road_closure'?'selected':''}>Road Closure</option><option value="checkpoint_closure" ${d.incident_type==='checkpoint_closure'?'selected':''}>Checkpoint</option><option value="structural_damage" ${d.incident_type==='structural_damage'?'selected':''}>Structural Damage</option><option value="power_outage" ${d.incident_type==='power_outage'?'selected':''}>Power Outage</option><option value="medical_emergency" ${d.incident_type==='medical_emergency'?'selected':''}>Medical Emergency</option><option value="security_incident" ${d.incident_type==='security_incident'?'selected':''}>Security</option><option value="settler_violence" ${d.incident_type==='settler_violence'?'selected':''}>Settler Violence</option><option value="sos" ${d.incident_type==='sos'?'selected':''}>SOS Alert</option></select></div>
    <div class="form-group"><label>${t('severity')}</label><select id="i_sev"><option value="low" ${d.severity==='low'?'selected':''}>Low</option><option value="medium" ${d.severity==='medium'?'selected':''}>Medium</option><option value="high" ${d.severity==='high'?'selected':''}>High</option><option value="critical" ${d.severity==='critical'?'selected':''}>Critical</option></select></div></div>
    <div class="form-row"><div class="form-group"><label>${t('latitude')}</label><input type="number" step="any" id="i_lat" value="${d.latitude||31.9}"></div><div class="form-group"><label>${t('longitude')}</label><input type="number" step="any" id="i_lon" value="${d.longitude||35.2}"></div></div>
    <div class="form-group"><label>${t('district')}</label><input id="i_dist" value="${d.district||''}"></div>
    <div class="form-group"><label>${t('description')}</label><textarea id="i_desc">${d.description||''}</textarea></div>
    <div class="form-row"><div class="form-group"><label>${t('is_active')}</label><select id="i_active"><option value="true" ${d.is_active!==false?'selected':''}>âœ…</option><option value="false" ${d.is_active===false?'selected':''}>âŒ</option></select></div>
    <div class="form-group"><label>${t('reported_by')}</label><input id="i_reporter" value="${d.reported_by||''}"></div></div>
    <div class="modal-actions"><button class="btn btn-primary" onclick="saveIncident(${isEdit?`'${d.id}'`:'null'})">${t('save')}</button><button class="btn" style="background:var(--border)" onclick="closeModal()">${t('cancel')}</button></div>`;
  }
  document.getElementById('modalContent').innerHTML=html;
  document.getElementById('modalOverlay').classList.add('active');
}

/* â•â•â•â•â•â•â• Save Functions â•â•â•â•â•â•â• */
async function saveFacility(id){
  const body={name:$('#f_name'),name_ar:$('#f_name_ar'),facility_type:$('#f_type'),status:$('#f_status'),latitude:+$('#f_lat'),longitude:+$('#f_lon'),governorate:$('#f_gov'),district:$('#f_dist'),address:$('#f_addr'),total_beds:+$('#f_tbeds'),available_beds:+$('#f_abeds'),icu_beds:+$('#f_ticu'),icu_available:+$('#f_aicu'),has_power:$('#f_power')==='true',has_oxygen:$('#f_oxy')==='true',phone:$('#f_phone')};
  try{
    if(id) await api(`/api/v1/facilities/${id}`,'PUT',body); else await api('/api/v1/facilities','POST',body);
    toast(id?t('updated'):t('created'));closeModal();loadAll();
  }catch(e){toast(t('error_op'),'error');}
}
async function saveResource(id){
  const body={name:$('#r_name'),resource_type:$('#r_type'),status:$('#r_status'),latitude:+$('#r_lat'),longitude:+$('#r_lon'),district:$('#r_dist'),total_capacity:+$('#r_cap'),current_occupancy:0,description:$('#r_desc'),contact_name:$('#r_cname'),contact_phone:$('#r_cphone')};
  try{
    if(id) await api(`/api/v1/resources/${id}`,'PUT',body); else await api('/api/v1/resources','POST',body);
    toast(id?t('updated'):t('created'));closeModal();loadAll();
  }catch(e){toast(t('error_op'),'error');}
}
async function saveIncident(id){
  const body={title:$('#i_title'),incident_type:$('#i_type'),severity:$('#i_sev'),latitude:+$('#i_lat'),longitude:+$('#i_lon'),district:$('#i_dist'),description:$('#i_desc'),is_active:$('#i_active')==='true',reported_by:$('#i_reporter')};
  try{
    if(id) await api(`/api/v1/incidents/${id}`,'PUT',body); else await api('/api/v1/incidents','POST',body);
    toast(id?t('updated'):t('created'));closeModal();loadAll();
  }catch(e){toast(t('error_op'),'error');}
}

function $(sel){const el=document.querySelector(sel);return el?el.value:'';}
function editFacility(id){const f=allFacilities.find(x=>x.id===id);if(f)openModal('facility',f);}
function editResource(id){const r=allResources.find(x=>x.id===id);if(r)openModal('resource',r);}
function editIncident(id){const i=allIncidents.find(x=>x.id===id);if(i)openModal('incident',i);}

/* â•â•â•â•â•â•â• Map â•â•â•â•â•â•â• */
let map=null, mapMarkers=[], mapFilter='all';
const MAP_COLORS={operational:'#22c55e',reduced_capacity:'#f59e0b',damaged:'#ef4444',offline:'#a855f7'};
const MAP_TYPE_ICONS={hospital:'ğŸ¥',clinic:'ğŸ©º',pharmacy:'ğŸ’Š',field_hospital:'â›º',health_center:'ğŸ›ï¸'};

function initMap(){
  if(map){map.invalidateSize();renderMapMarkers();return;}
  map=L.map('facilityMap',{zoomControl:true}).setView([31.9522,35.2332],9);
  const isDark=THEME==='dark';
  L.tileLayer(isDark?'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png':'https://tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap',maxZoom:18
  }).addTo(map);
  buildMapLegend();
  buildMapFilters();
  renderMapMarkers();
}

function buildMapLegend(){
  const items=[
    {color:'#22c55e',label:LANG==='ar'?'Ø¹Ø§Ù…Ù„':'Operational'},
    {color:'#f59e0b',label:LANG==='ar'?'Ø·Ø§Ù‚Ø© Ù…Ø®ÙØ¶Ø©':'Reduced'},
    {color:'#ef4444',label:LANG==='ar'?'Ù…ØªØ¶Ø±Ø±':'Damaged'},
    {color:'#a855f7',label:LANG==='ar'?'ØºÙŠØ± Ù…ØªØµÙ„':'Offline'},
  ];
  document.getElementById('mapLegend').innerHTML=items.map(i=>`<div class="map-legend-item"><div class="map-legend-dot" style="background:${i.color}"></div>${i.label}</div>`).join('');
}

function buildMapFilters(){
  const filters=[
    {key:'all',label:LANG==='ar'?'Ø§Ù„ÙƒÙ„':'All'},
    {key:'hospital',label:LANG==='ar'?'Ù…Ø³ØªØ´ÙÙ‰':'Hospital'},
    {key:'clinic',label:LANG==='ar'?'Ø¹ÙŠØ§Ø¯Ø©':'Clinic'},
    {key:'operational',label:LANG==='ar'?'Ø¹Ø§Ù…Ù„':'Operational'},
    {key:'damaged',label:LANG==='ar'?'Ù…ØªØ¶Ø±Ø±':'Damaged'},
  ];
  document.getElementById('mapFilters').innerHTML=filters.map(f=>`<button class="map-chip ${mapFilter===f.key?'active':''}" onclick="setMapFilter('${f.key}')">${f.label}</button>`).join('');
}

function setMapFilter(f){mapFilter=f;buildMapFilters();renderMapMarkers();}

function renderMapMarkers(){
  mapMarkers.forEach(m=>map.removeLayer(m));mapMarkers=[];
  let fList=allFacilities;
  if(mapFilter==='hospital'||mapFilter==='clinic'||mapFilter==='pharmacy'||mapFilter==='health_center'||mapFilter==='field_hospital'){
    fList=fList.filter(f=>f.facility_type===mapFilter);
  }else if(mapFilter==='operational'||mapFilter==='damaged'||mapFilter==='reduced_capacity'||mapFilter==='offline'){
    fList=fList.filter(f=>f.status===mapFilter);
  }
  fList.forEach(f=>{
    if(!f.latitude||!f.longitude)return;
    const color=MAP_COLORS[f.status]||'#94a3b8';
    const icon=L.divIcon({
      className:'',
      html:`<div style="background:${color};width:28px;height:28px;border-radius:50%;border:3px solid rgba(255,255,255,.7);display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,.3);cursor:pointer">${MAP_TYPE_ICONS[f.facility_type]||'ğŸ¥'}</div>`,
      iconSize:[28,28],iconAnchor:[14,14]
    });
    const powerBg=f.has_power?'#dcfce7':'#fee2e2', powerClr=f.has_power?'#16a34a':'#dc2626';
    const oxyBg=f.has_oxygen?'#dbeafe':'#fee2e2', oxyClr=f.has_oxygen?'#2563eb':'#dc2626';
    const statusBg=f.status==='operational'?'#dcfce7':f.status==='damaged'?'#fee2e2':'#fef9c3';
    const statusClr=f.status==='operational'?'#16a34a':f.status==='damaged'?'#dc2626':'#ca8a04';
    const popup=`<div class="map-popup" style="min-width:200px">
      <h4>${MAP_TYPE_ICONS[f.facility_type]||''} ${f.name}</h4>
      ${f.name_ar?`<div class="mp-row" style="font-family:Cairo">${f.name_ar}</div>`:''}
      <div class="mp-row"><span class="mp-badge" style="background:${statusBg};color:${statusClr}">${sLabel(f.status)}</span> Â· ${tLabel(f.facility_type)}</div>
      <div class="mp-row">ğŸ“ ${f.governorate||f.district||'-'}</div>
      <div class="mp-row">ğŸ›ï¸ ${LANG==='ar'?'Ø£Ø³Ø±Ù‘Ø©':'Beds'}: ${f.available_beds}/${f.total_beds}  |  ICU: ${f.icu_available||0}/${f.icu_beds||0}</div>
      <div class="mp-row"><span class="mp-badge" style="background:${powerBg};color:${powerClr}">${f.has_power?'âš¡':'âŒ'} ${LANG==='ar'?'ÙƒÙ‡Ø±Ø¨Ø§Ø¡':'Power'}</span> <span class="mp-badge" style="background:${oxyBg};color:${oxyClr}">${f.has_oxygen?'ğŸ’¨':'âŒ'} ${LANG==='ar'?'Ø£ÙƒØ³Ø¬ÙŠÙ†':'Oâ‚‚'}</span></div>
      ${f.phone?`<div class="mp-row">ğŸ“ ${f.phone}</div>`:''}
    </div>`;
    const marker=L.marker([f.latitude,f.longitude],{icon}).bindPopup(popup,{maxWidth:280});
    marker.addTo(map);
    mapMarkers.push(marker);
  });
}

/* â•â•â•â•â•â•â• SOS Alerts Polling â•â•â•â•â•â•â• */
let sosPollingInterval = null;
const SOS_I18N = {
  ar: {
    sos_title: 'ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù†Ø¬Ø¯Ø©',
    sos_sub: 'Ø¨Ù„Ø§ØºØ§Øª Ø·ÙˆØ§Ø±Ø¦ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
    sos_locate: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹',
    sos_ago: 'Ù…Ù†Ø°',
    sos_min: 'Ø¯Ù‚ÙŠÙ‚Ø©',
    sos_just: 'Ø§Ù„Ø¢Ù†',
  },
  en: {
    sos_title: 'ğŸš¨ SOS ALERTS',
    sos_sub: 'Real-time emergency reports from mobile users',
    sos_locate: 'Locate',
    sos_ago: '',
    sos_min: 'min ago',
    sos_just: 'Just now',
  },
};
const st = k => SOS_I18N[LANG]?.[k] || SOS_I18N['en']?.[k] || k;

const SOS_ICONS = {
  'red_crescent': 'ğŸ¥',
  'civil_defense': 'ğŸš’',
  'police': 'ğŸš”',
  'nearest_hospital': 'ğŸ“',
};

function timeAgo(iso) {
  if (!iso) return '';
  const diff = Math.floor((Date.now() - new Date(iso).getTime()) / 60000);
  if (diff < 1) return st('sos_just');
  return `${st('sos_ago')} ${diff} ${st('sos_min')}`.trim();
}

async function pollSOS() {
  try {
    const alerts = await api('/api/v1/sos/recent?minutes=60');
    const banner = document.getElementById('sosAlertsBanner');
    const list = document.getElementById('sosAlertList');
    const count = document.getElementById('sosAlertCount');
    const titleEl = document.getElementById('sosAlertTitle');
    const subEl = document.getElementById('sosAlertSub');

    if (!alerts || alerts.length === 0) {
      banner.style.display = 'none';
      return;
    }

    banner.style.display = 'block';
    count.textContent = alerts.length;
    titleEl.textContent = st('sos_title');
    subEl.textContent = st('sos_sub');

    list.innerHTML = alerts.map(a => {
      const icon = SOS_ICONS[a.description?.replace('SOS alert: ', '')] || 'ğŸ†˜';
      return `<div class="sos-card">
        <span class="sos-icon">${icon}</span>
        <div class="sos-info">
          <h4>${a.title}</h4>
          <p>ğŸ“ ${a.latitude?.toFixed(4)}, ${a.longitude?.toFixed(4)} Â· ${LANG === 'ar' ? 'Ø¨ÙˆØ§Ø³Ø·Ø©' : 'by'} ${a.reported_by || '?'}</p>
        </div>
        <span class="sos-time">${timeAgo(a.reported_at)}</span>
        <button class="sos-locate" onclick="locateSOS(${a.latitude},${a.longitude})">${st('sos_locate')}</button>
      </div>`;
    }).join('');

  } catch (e) {
    // Silent fail â€” don't break dashboard
    console.warn('SOS poll error:', e);
  }
}

function locateSOS(lat, lon) {
  switchTab('map');
  initMap();
  setTimeout(() => {
    if (map) {
      map.setView([lat, lon], 15);
      L.circleMarker([lat, lon], {
        radius: 14, color: '#ef4444', fillColor: '#ef4444', fillOpacity: 0.5, weight: 3
      }).addTo(map).bindPopup(`<b>ğŸš¨ SOS Location</b><br>${lat.toFixed(4)}, ${lon.toFixed(4)}`).openPopup();
    }
  }, 500);
}

// Start SOS polling every 10 seconds
function startSOSPolling() {
  pollSOS(); // immediate first poll
  if (sosPollingInterval) clearInterval(sosPollingInterval);
  sosPollingInterval = setInterval(pollSOS, 10000);
}

/* â•â•â•â•â•â•â• Init â•â•â•â•â•â•â• */
async function loadAll(){await Promise.all([loadDashboard(),loadFacilities(),loadResources(),loadIncidents()]);}

applyTheme();applyLang();loadAll();startSOSPolling();
</script>
</body>
</html>